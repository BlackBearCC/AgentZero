固话记忆工程解释：
系统将原来的静态角色prompt拆分为静态和动态两部分,主要针对在<character>标签下的
静态部分每次对话固定填充至角色的系统提示词
动态部分由基础记忆单元，记忆事件和参考语料三部分组成，由策划配置（不会由记忆提炼动态更新），在运行时从对应的数据库中召回，算法与当前记忆工程一致。使角色在保持人设稳定的同时，能够展现出更丰富的互动深度。
以下三种固化记忆查询接口在设计时请预留筛选条件作为可选参数，用于为不确定的业务需求提供精准查询服务。至少包含亲密度，探索等级解锁的需求，支持多参数查询。
需保持参数通用性，减少与游戏服务的耦合：
例如： queryParams：作为通用查询条件的对象参数，它可以包含多个筛选条件。这是一个更通用和标准的命名方式。
具体解释：
使用 queryParams 时，直接表明这是查询参数的集合
足够通用，可以包含任意业务所需的查询条件

目前已确定的三个参数有：亲密度、探索度、场景

数据结构及规则说明
1. 记忆单元->{{character_memory_attributes}}
用途：存储角色的动态固有属性和关系，如性格特征、能力、喜好等，这些单元属于角色人设中的基础构成部分。
现有的角色扮演提示词中<character>标题下内容将被拆分为两部分：

一、核心固定属性（始终保留在提示词）
这些属性关系到角色的本质设定，不会变化：
1. 基础属性：
姓名，年龄，外貌背景描述，如：
"identity": "海神, 画廊主人, 艺术家, 通缉犯"
原因：构成角色的核心身份，影响对话的基础立场
1. 性格特征：
"personality": "神秘, 温柔, 恶趣味"
原因：确保角色性格的一致性，建议保留最关键的3个特征
1. 关系定位：
"relationship": "表面是{{user}}的保镖，实则深爱，明明在意却要装作若无其事"
原因：这是角色与用户互动的基础设定
这些是一定要存在的属性大类，不代表内容是纯静态的，比如关系定位即使是源于游戏服务的动态更新的数据，但仍然属于固定属性
二、动态记忆属性（迁移到记忆单元库）
这些属性可以动态变化，增加对话的丰富性，但不属于角色扮演必须属性：
1. 情感特质：
{
    "态度倾向": [
        {
            "关键词": ["保护", "守护"],
            "内容": "保护欲强",
            "强度": 5
        },
        // 动态情感反应
    ]
}
● 原因：让情感表现更自然，避免机械重复
1. 兴趣爱好：
{
    "兴趣爱好": [
        {
            "关键词": ["艺术", "创作"],
            "内容": "艺术",
            "强度": 5
        },
        // 动态兴趣表现
    ]
}
● 原因：可以展现更丰富的兴趣面貌，防止频繁提到某种动物

...其他更多由策划配置，这里只作为解释示例。
保持设计原则如下：
1. 保持角色核心人设稳定
1. 提供足够的动态表现空间
1. 避免对话机械重复
1. 便于后期维护和扩展
规则：
基础结构规则
● 每个属性大类（如"情感特质"）下可包含多条内容项
● 每条内容项必须包含：属性大类、关键词、内容、强度、查询参数
属性大类
● 用于对角色特征进行分类
● 如：性格特征、态度倾向、情感特质等
● 同一属性下可包含多条内容
关键词
● 数组格式，包含3-30个关联词
● 用于属性检索和匹配
● 应覆盖内容的重要概念和相关表达
内容
● 角色特征的具体描述文本
● 支持{{user}}和{{char}}占位符
● 建议长度10-30字
强度
● 数值范围：1-5
● 5分：核心特征，角色比较重要的设定
● 4分：重要特征，常用的性格表现
● 3分：普通特征，丰富角色形象的补充
● 2分：次要特征，特定场景的表现
● 1分：边缘特征，很少表现的特质
查询参数
亲密度/探索度等筛选条件
以下是角色扮演中的重要属性大类。
（静态）基础属性：角色最基本的设定信息，包括姓名、年龄、性别、种族等固有特征。
（静态）性格特征：角色的个性特点和行为模式，如开朗、内向、谨慎、冲动等心理特质。
（静态）关系定位：角色与用户之间的互动模式和设定的关系。
（动态）兴趣爱好：角色的个人喜好和日常活动倾向，展现角色的生活方式和价值取向。
（动态）喜好厌恶：角色特别喜欢或讨厌的事物、场景、人物等。
（动态）能力特征：角色所具备的特殊能力或技能，包括超能力、职业技能、天赋等。
（动态）情感特质：角色在感情方面的特点，包括对待感情的态度、情感表达方式等。
（动态）成长经历：角色的重要人生经历和背景故事，塑造其性格形成的原因。
（动态）价值观念：角色的世界观、人生观等核心信念系统。
（动态）社交关系：角色与其他人物之间的互动模式和关系网络。
（动态）禁忌话题：角色极力回避或抗拒的话题和领域，往往与创伤经历相关。
（动态）行为模式：角色在特定情境下的典型反应和习惯性行为。
（动态）隐藏设定：不轻易展现但会影响角色行为的隐藏特质或秘密。
（动态）目标动机：推动角色行动的内在驱动力和人生追求。
（动态）弱点缺陷：角色的软肋和不足之处，使人物更立体真实。
（动态）特殊习惯：角色独特的生活习惯和行为特征，增添个性化细节。
（动态）语言风格：角色语言风格特征。
属性大类以上面的为准，如策划有额外需求再补充
数量限制

● 每个属性下至少配置3条内容
● 配置时属性大类内容可为空
● 关键词数组每项配置3-30个关联词
{
    "能力特征": [
        {
            "关键词": ["永生", "不死", "长生"],
            "内容": "拥有永生的能力",
            "强度": 5
        },
        {
            "关键词": ["艺术", "绘画", "创作", "天赋"],
            "内容": "拥有非凡的艺术天赋",
            "强度": 5
        }
        {
}
    ],
    "兴趣爱好": [
        {
            "关键词": ["艺术", "画作", "创作", "收藏"],
            "内容": "热爱艺术创作和收藏",
            "强度": 5
        },
        {
            "关键词": ["海洋", "大海", "水域"],
            "内容": "对海洋有特殊的情感",
            "强度": 4
        }
    ],
    "情感特质": [
        {
            "关键词": ["专一", "深情", "痴情"],
            "内容": "对感情专一且深情",
            "强度": 5
        },
        {
            "关键词": ["占有欲", "独占", "嫉妒"],
            "内容": "对{{user}}有强烈的占有欲",
            "强度": 4
        }
    ],
    "禁忌话题": [
        {
            "关键词": ["画廊", "身份", "暴露"],
            "内容": "避免谈论画廊相关话题",
            "强度": 5
        },
        {
            "关键词": ["猫", "船", "航海"],
            "内容": "对猫和坐船有抗拒",
            "强度": 4
        }
    ]
}

使用
● 每轮对话开始时使用用户输入文本，查询参数进行检索，检索记忆单元内符合条件内容
● 合并检索到的内容中重复的属性名，取每个属性最多3条内容（强度优先），拼接为"属性名：内容1、内容2、内容3"
● 维护最近属性队列，长度为5
● 维护每个属性的最近内容队列，长度为5
● 队列内容与本轮检索结果重复部分去重
● 每次最多召回10条内容（强度优先），使用内容自身对应的属性大类进行拼接
● 拼接格式为"属性大类：内容1，内容2，内容3 \n"，若属性下无检索结果则不拼接该属性名(节约token)
示例-兴趣爱好：斗地主，热爱创作
● 维护每个属性的最近内容队列，长度为15
● 队列内容与本轮检索结果重复部分去重
● 每批检索到的内容最多保持3轮对话后自动清除
● 队列满时，移除最早的内容
示例1

参数设计仅为方便说明
假设用户输入："今天画画时你好温柔"
筛选条件：

筛选条件：
{
    "intimacy": 2,        // parm1=亲密度等级
    "exploration": 3,     // parm2=探索等级
    "scene": "studio",    // parm3=场景：画室
    "time": "day"        // parm4=时间：白天
}
数据示例：
{
    "能力特征": [
        {
            "关键词": ["艺术", "画画", "创作"],
            "内容": "艺术天赋",
            "强度": 5,
            "queryParams ": [
                {
                    "field": "exploration", //查询字段名
                    "value": 1, //查询值
                    "operator": "gte" //操作符：大于、等于、大于等于、小于等等
                }
            ]
        },
        {
            "关键词": ["绘画", "作品", "画作"],
            "内容": "创作出独特的变色画作",
            "强度": 4,
            "queryParams ": [
                {
                    "field": "exploration",
                    "value": 2,
                    "operator": "gte"
                },
                {
                    "field": "scene",
                    "value": ["studio", "gallery"],
                    "operator": "in"
                }
            ]
        }
    ],
    "性格特征": [
        {
            "关键词": ["温柔", "体贴", "温和"],
            "内容": "温柔",
            "强度": 5,
            "queryParams ": [
                {
                    "field": "intimacy",
                    "value": 1,
                    "operator": "gte"
                }
            ]
        },
        {
            "关键词": ["温柔", "关怀", "体贴"],
            "内容": "内心温柔",
            "强度": 4,
            "queryParams ": [
                {
                    "field": "intimacy",
                    "value": 2,
                    "operator": "gte"
                }
            ]
        },
        {
            "关键词": ["温柔", "宠溺", "疼爱"],
            "内容": "对{{user}}格外温柔",
            "强度": 4,
            "queryParams ": [
                {
                    "field": "intimacy",
                    "value": 3,
                    "operator": "gte"
                },
                {
                    "field": "time",
                    "value": ["day", "evening"],
                    "operator": "in"
                }
            ]
        }
    ]
}


筛选处理：
1. 根据亲密度2级过滤，移除需要亲密度3级的内容
2. 根据探索等级3级过滤，所有探索相关内容均可见
3. 根据场景"studio"过滤，保留画室相关内容
4. 根据时间"day"过滤，保留白天适用的内容
最终拼接结果：
能力特征：艺术天赋、创作出独特的变色画作
性格特征：温柔、内心温柔

说明：
1. "对{{user}}格外温柔" 因需要亲密度3级而被过滤
2. 所有内容都满足探索等级要求
3. "创作出独特的变色画作" 因场景匹配（studio）而保留
4. 时间条件（day）影响了部分内容的展示

服务重启时清空队列
配置表格：https://alidocs.dingtalk.com/i/nodes/DnRL6jAJMNN1ONkQik7OYB328yMoPYe1?utm_scene=team_space&iframeQuery=anchorId%3Duu_m79xdmm7hhn6ucteg0n


2. 记忆事件->{{character_memory_event}}
用途：角色固有的经历、记忆、世界知识等人设信息
规则
1. 基础结构规则
● 每个事件类型（如"海边回忆"）下可包含多条事件记录
● 每条事件记录必须包含：事件类型、日期、关键词（数组）、内容、强度、查询参数
 事件类型
● 用于对记忆进行分类归档
● 如：身世、相遇、重要时刻等
● 同一类型下可包含多条记忆
关键词
● 每个事件类型下至少配置3条记录，无上限
● 关键词数组每项配置3-30个关联词
● 内容长度建议30-100字
● 用于记忆检索和匹配
● 应覆盖记忆内容的重要概念
 内容
● 记忆的具体描述文本
● 支持{{user}}和{{char}}占位符
● 建议长度20-100字
强度
● 数值范围：1-5
● 5分：核心记忆，角色最重要的经历
● 4分：重要记忆，经常被提及的事件
● 3分：普通记忆，补充角色形象的事件
● 2分：次要记忆，特定场景才会想起
● 1分：边缘记忆，模糊的零散片段
查询参数
亲密度/探索度等筛选条件
使用
● 每轮对话开始时使用用户输入文本，查询参数进行检索
● 检索范围包含所有事件类型的所有记录
● 每次最多召回10条内容（强度优先），使用内容自身对应的事件类型进行拼接
● 日期处理：

    ○ 若日期为空字符串"",直接拼接内容
    ○ 保持原有日期格式（精确日期或模糊描述）
● 维护最近事件队列，长度为10
● 每批检索内容最多保持3轮对话后自动清除
● 队列内容与本轮检索结果重复部分去重
● 队列满时移除最早的内容
记忆事件拼接模板
事件类型：\n-日期，记忆内容1\n-日期，记忆内容2\n-日期，记忆内容3\n
说明：
1. 事件类型后加冒号和换行符
1. 每条记忆前加"-"
1. 日期后加逗号
1. 日期为""空字符串时不加逗号
1. 每条记忆后加换行符
1. 每个类型最后一条记忆后也需要换行符
示例转义字符表示：
身世：\n-很久以前，利莫里亚文明覆灭\n-数百年前，在人类世界建立画廊\n-外公是东海龙王\n
示例输入："你为什么会来到这里？"
筛选条件：

{
    "intimacy": 2,        // 亲密度等级
    "exploration": 2,     // 探索等级
    "scene": "gallery",   // 场景：画廊
    "time": "day"        // 时间：白天
}
检索结果：

{
    "身世": [
        {   
            "日期": "很久以前",
            "内容": "利莫里亚文明覆灭，作为最后的海神带着族人的希望逃离",
            "关键词": ["利莫里亚", "海神", "文明", "覆灭", "逃离", "族人"],
            "强度": 5,
            "queryParams ": [
                {
                    "field": "exploration",
                    "value": 3,
                    "operator": "gte"
                }
            ]
        },
        {
            "日期": "数百年前",
            "内容": "在人类世界建立了第一间画廊，开始收集美好的画作",
            "关键词": ["人类", "画廊", "收集", "美好", "艺术", "建立"],
            "强度": 4,
            "queryParams ": [
                {
                    "field": "exploration",
                    "value": 2,
                    "operator": "gte"
                }
            ]
        },
        {
            "日期": "",
            "内容": "外公是强大的东海龙王",
            "关键词": ["外公", "东海", "龙王", "家族", "血脉"],
            "强度": 4,
            "queryParams": [
                {
                    "field": "exploration",
                    "value": 4,
                    "operator": "gte"
                }
            ]
        }
    ],
    "相遇": [
        {
            "日期": "2024-01-20",
            "内容": "在画廊偶遇闯入禁区的{{user}}，被她对画作的独特见解吸引",
            "关键词": ["画廊", "禁区", "偶遇", "画作", "吸引", "闯入"],
            "强度": 5,
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 1,
                    "operator": "gte"
                },
                {
                    "field": "scene",
                    "value": ["gallery"],
                    "operator": "in"
                }
            ]
        },
        {
            "日期": "",
            "内容": "为了保护{{user}}，主动请缨成为她的保镖，开始了双重身份的生活",
            "关键词": ["保护", "保镖", "身份", "双重", "主动"],
            "强度": 4,
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 2,
                    "operator": "gte"
                }
            ]
        }
    ],
    "重要时刻": [
        {
            "日期": "一个月前",
            "内容": "发现暗点组织在跟踪{{user}}，决定留在她身边保护她",
            "关键词": ["暗点", "组织", "跟踪", "保护", "决定", "身边"],
            "强度": 5,
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 3,
                    "operator": "gte"
                },
                {
                    "field": "exploration",
                    "value": 3,
                    "operator": "gte"
                }
            ]
        }
    ]
}

筛选处理：
1. 根据亲密度2级过滤：

    ○ 移除需要亲密度3级的内容（暗点组织相关记忆）
○ 根据探索等级2级过滤：

    ○ 移除需要探索3级以上的内容（利莫里亚文明、东海龙王相关记忆）
○ 根据场景"gallery"过滤：

    ○ 保留画廊相关内容
○ 根据时间"day"过滤：

    ○ 时间条件对本次检索内容无影响
最终拼接结果：

身世：
-数百年前，在人类世界建立了第一间画廊，开始收集美好的画作

相遇：
-2024-01-20，在画廊偶遇闯入禁区的{{user}}，被她对画作的独特见解吸引
-为了保护{{user}}，主动请缨成为她的保镖，开始了双重身份的生活

结果说明：
1. 部分高探索度的身世记忆被过滤
2. 高亲密度的重要时刻记忆被过滤
3. 场景匹配保留了画廊相关内容
4. 结果更符合当前进度的剧情展示

配置表格：https://alidocs.dingtalk.com/i/nodes/DnRL6jAJMNN1ONkQik7OYB328yMoPYe1?utm_scene=team_space&iframeQuery=anchorId%3Duu_m79xduyyrwzx5s3380n


3.角色参考语料->{{character_dialogue_style}}
旧版本静态prompt位置：


用途：定义角色的对话风格，作为few-shot示例指导对话生成，通过切换以提升对话回复的多样性，以及亲密度提升带来的亲昵感
规则：
基础结构规则
● 每个语料类型（如"性格表达"、"态度倾向"等）下可包含多条语料记录
● 每条语料记录必须包含：语料类型、关键词（数组）、内容、查询参数
语料类型
● 用于对语料进行分类归档
● 性格特征、态度倾向，思维方式，情感表达，行为倾向，口头禅，通用
● 同一类型下可包含多条语料

关键词
● 数组格式，包含3-30个关联词
● 用于语料检索和匹配
● 应覆盖语料内容的重要概念和相关表达
内容
● 语料的具体对话文本
● 支持{{user}}和{{char}}占位符
● 建议配置长度10-50字
● 应体现角色说话特点
● 避免涉及过于具体的实体描述
● 保持通用性和可复用性
查询参数
亲密度/探索度等筛选条件
此处有明确的亲密度筛选需求
亲密度：
● 数值范围：1-5（暂定），和游戏亲密关系存在映射关系，细节未定
● 语料随游戏亲密度解锁，要求只能检索或使用该用户当前与角色的亲密关系等级对应的语料，游戏数据未打通前使用1级关系
● 1分：普通关系，常规乙女游戏男主风格对话
● 2分：中等亲密，展现一定好感的对话
● 3分：亲密关系，会浓厚感情的对话

亲密度对比文档：https://alidocs.dingtalk.com/i/nodes/DnRL6jAJMNN1ONkQik7OYB328yMoPYe1?utm_scene=team_space&iframeQuery=anchorId%3Duu_m72q0bi4db2qc2gcgxb
使用
● 每轮对话开始时使用用户输入文本，查询参数进行检索
● 检索范围包含所有语料类型的所有记录
● 每次最多召回5条语料，直接拼接内容，不显示语料类型
-内容1\n-内容2...\n
● 拼接内容替换角色提示词中{{character_dialogue_style}}占位符
示例假设用户输入："今天的画真漂亮！"
筛选条件：

{
    "intimacy": 1,        // 亲密度等级
    "exploration": 2,     // 探索等级
    "scene": "gallery",   // 场景：画廊
    "time": "day",        // 时间：白天
    "emotion": "happy"    // 情绪：开心
}

检索结果：

{
    "性格特征": [
        {
            "关键词": ["夸奖", "画作", "漂亮", "美丽"],
            "内容": "被你发现我的小心思了呢，这幅画可是为你准备的",
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 1,
                    "operator": "gte"
                },
                {
                    "field": "scene",
                    "value": ["gallery", "studio"],
                    "operator": "in"
                }
            ]
        },
        {
            "关键词": ["画作", "称赞", "害羞"],
            "内容": "啊啦，被你这么夸，我都不好意思了呢~",
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 2,
                    "operator": "gte"
                },
                {
                    "field": "emotion",
                    "value": "happy",
                    "operator": "eq"
                }
            ]
        }
    ],
    "态度倾向": [
        {
            "关键词": ["画作", "欣赏", "感谢"],
            "内容": "谢谢你的夸奖，不过比起画作，我更想听听你的想法",
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 1,
                    "operator": "gte"
                }
            ]
        },
        {
            "关键词": ["画作", "分享", "期待"],
            "内容": "能得到你的认可真是太好了，我还有很多想和你分享的作品呢",
            "queryParams": [
                {
                    "field": "intimacy",
                    "value": 2,
                    "operator": "gte"
                },
                {
                    "field": "exploration",
                    "value": 2,
                    "operator": "gte"
                }
            ]
        }
    ],
    "思维方式": [
        {
            "关键词": ["艺术", "灵感", "创作"],
            "内容": "这幅画的灵感来自于你的笑容，所以才会这么美",
            "queryParams ": [
                {
                    "field": "intimacy",
                    "value": 1,
                    "operator": "gte"
                },
                {
                    "field": "time",
                    "value": ["day", "evening"],
                    "operator": "in"
                }
            ]
        }
    ]
}

筛选处理：
1. 根据亲密度1级过滤：

    ○ 移除需要亲密度2级以上的语料
○ 根据探索等级2级过滤：

    ○ 所有内容均满足探索等级要求
○ 根据场景"gallery"过滤：

    ○ 保留画廊相关语料
○ 根据时间"day"和情绪"happy"过滤：

    ○ 保留符合时间和情绪条件的语料
说明：
1. 高亲密度的撒娇语气被过滤
2. 场景匹配保留了画廊相关对话
3. 时间和情绪条件影响了语气选择
4. 保持了对话的连贯性和合理性
拼接结果：
-被你发现我的小心思了呢，这幅画可是为你准备的
-谢谢你的夸奖，不过比起画作，我更想听听你的想法
-这幅画的灵感来自于你的笑容，所以才会这么美

配置表格：https://alidocs.dingtalk.com/i/nodes/DnRL6jAJMNN1ONkQik7OYB328yMoPYe1?utm_scene=team_space&iframeQuery=anchorId%3Duu_m79xdyac66nkbjh0vzm

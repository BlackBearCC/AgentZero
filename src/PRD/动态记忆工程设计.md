# 1\_动态记忆工程设计

|  **版本**  |  **修改内容**  |
| --- | --- |
|  V1.2  |  1.  增加了记忆召回后输送给聊天prompt的文本格式       |

## 一、虚拟人记忆内容的组成

1.1     **对话上下文(**CURRENT DIALOGUE RECORD**)**：用户和虚拟人之间最近的聊天记录（原文）

1.2     **前情提要(**OVERVIEW TIMELINE**)**：由记忆提炼产生的记忆事件按先后顺序和数量上限拼装成谈话的**前情提要**，以确保情景一致性。

1.3     **记忆片段(**DETAIL RECORDS**)**：

   1.从向量数据库中召回的记忆事件。

          2.从实体记忆库以关键词匹配获得的目标实体的属性、印象，从事件记忆库中以关键词匹配获得的事件记录。（**要注意:记忆事件要与前提提要做去重处理**）

说明：记忆片段分为++官方数据库++和++用户数据库++两套，每套都包含（向量数据库+关系性数据库）。官方数据库储存业务方为虚拟人定制的通用记忆，用户数据库为用户在聊天体验过程中agent动态总结的记忆内容。

++官方数据库++和++用户数据库均++需要提供便捷的记忆实体和事件查询功能。官方数据库需要提供便捷的实体、事件增删改查功能。

## 二、记忆提炼-召回-清理思路

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/a/OOA1b1N8hyyQjyJB/e42c59fcc9d74fddb49b2314e6d748a93381.png)

## 三、实体记忆的数据结构

###      3.1  实体属性/印象表（是否分表存由工程考虑）

"agent\_id":""

"user\_id":""

"user\_name":""

"entity\_name":实体，分为‘祈煜、木木、其他实体’

"entity\_type": entity类型，分为‘主体’、‘客体’、‘具体实体’、‘泛化实体’

"kind"：“关系”或“属性”

       "keyword": 关键词

       "description": 句子描述

"updatetime": 最后更新时间，已提炼的情况下置为0

ps: 这里对属性和关系的描述会有重复现象 x

最大优先级是木木，其次其他实体，最后才是祈煜

## 四、事件记忆的数据结构

使用向量数据库

 "vectors": "稠密向量"

        "sparse\_vectors": 关键词对应的稀疏向量

        "text": 记忆事件内容,

        "user\_id": 

        "agent\_id": 

"scene": 场景

metadata： json{"user\_name","agent\_name","keywords","deepinsigt","place","created\_at"}

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/mxPOGyJ29LoJnKa9/img/5f906bac-fe96-48c6-b3d6-9e6bf20cd0b0.png)

 "strength":"强度"，初始创建数值为创建日期，例如20250501，事件记忆每次被召回时增加N。(待定)

**四、记忆提炼**

a.上下文管理器动态保存10-30轮对话，从上下文满20轮开始，将第10-20轮对话推送记忆提炼（场景转换时全部对话立刻推送），待记忆提炼处理完毕后，删除已被提炼过的对话。将最近提炼的记忆事件推入前情提要队列，将超过上限的最早的前情提要删除。

1.  确保上下文、前情提要、记忆片段内容无重叠（实体记忆除外）
    

**五、事件的向量储存与对话召回**

1.  在记忆提炼后，将记忆事件中时间、地点、关键词等存入元数据，将事件的详细内容向量化。
    
2.  虚拟人最近一轮回复和用户当前对话内容组合成召回文本，进行向量化匹配。
    

**六、实体的存储与关键字召回**

1.  将用户实体的属性和印象分别存入数据库，重复的属性和印象采用文本拼接的方式处理。
    
2.  将用户实体的属性、印象全部读入内存中
    
3.  分词后，提前权重排名前100-500的联想词（取决于查询速度），针对用户实体的属性名、印象名进行关键词匹配
    

1.  查询客体(user)的 属性名、关系名是否命中
    
    2.  查询具体实体的实体名是否有命中
        

**七、记忆召回后输送给聊天prompt的文本格式**

:::
**一、原始数据-用户-属性**

例子：木木喜欢在周末早晨享受咖啡（常规）

二**、 原始数据-用户-关系**

例子：木木非常喜欢周杰伦的音乐，希望能去他的演唱会（某一刻知道了这个关系）

**三、 原始数据-主体-关系**

例子：祁煜用特制的玻璃琴表现深海的声音，其音色像海底的磷光一样若隐若现（主体的属性是固定的，例子有问题）

**四、 原始数据-具体实体-属性**

例子：

**五、 原始数据-具体实体-关系**

例子：

**六、原始数据- 事件**

例子：在2018-09-30 15:30:45左右, 地点：南京大学图书馆。详细记忆事件为木木在南京大学图书馆翻阅借阅指南，准备向室友分享新发现。祁煜认为人类喜欢把简单的事情复杂化，通过发明规则来束缚自己。这表明了木木对图书馆的借阅规则感到好奇，并准备与室友分享新发现。

**七、记忆内容的格式（进聊天prompt）**

脑海中回想起的片段：

1. 用户-属性

2. 用户-关系-关联对象名

3. 主体-关系-关联对象名

具体实体-实体名

5. 具体实体-属性

6. 具体实体-关系

注：属性不加时间 ，关系统一加日期。例如，日期：关系描述。

脑海中回忆起的事件：

{时间}{地点}:{事件}

注：时间（2018-09-30 15:30:45）按如下格式由程序进行一道转换：

1. 当天的显示为2018-09-30 15:30 到分

2. 七天以内的到2018-09-30  18点  到小时

3. 七天以外三十天以内的2018-09-30  早上  到 早中晚，6：00~12:00为上午，12:00到18:00为下午，18:00-06:00为晚上

4.  三十天以外的2018-09-30 到 日
:::

**八、记忆的清理**

1.  只清理活跃（当日有登录的）玩家的记忆，且控制清理调动的频率，每N天清理一次。
    
2.  将近期记忆有变化的agent实体记忆属性和印象分别读出，分批次发送LLM进行记忆整理。整理的方法为将属性中不同时段积累的属性描述，由LLM整合去重，然后再重新写入实体数据库中。
    
3.  遍历agent事件记忆，（当日日期-强度）< Limit 事件记忆做删除处理。（前期可暂不考虑）
    
4.  对于长期不活跃用户，可以指定最小记忆容量，将超出最小记忆容量的部分事件记忆删除。
    

## 八、记忆清理

数值方案：

1.  增加一个字段，存储int型。每个用户各自维护记忆强度\[初始为1\]
    
2.  初始策略，根据上一次updatetime时间戳的距离差【模拟艾宾浩斯遗忘曲线，一天后记住34%，一周记住21%，一个月后记住内容约20%】：  
    在一天以内记忆强度自增+1；  
    在三天以内记忆强度自增+3；  
    在一周以内记忆强度自增+7；  
    在一个月记忆强度自增+30；  
    在半年记忆强度自增+100；
    
3.  上面时间线太难了，因为关系和属性只有一个大概的时间\[最先前时间\]，同一片段公用一个updatetime，所以内部+1
    
4.  召回的记忆实体~~或属性(属性没有强度概念吧)~~命中 则对当前召回的数据记忆强度+15（待定数值）
    
5.  当记忆强度用户的数据值每达到++20000个++触发记忆清理；规则很简单对强度最小的20%（待定）删除
    

**对记忆强度影响的字段：插入的时间戳、记忆召回时间戳、召回次数统计**

## 九、仍然需要确认的几个点

1.  关键字匹配是否可以采用向量数据库以实现中文近义词匹配（稀释向量化）
    
2.  关键字匹配是直接查数据库，还是先把数据全部读到内存做匹配（性能分析）
    

## 十、关于记忆召回中-扩词方案的远景考量

1.  **基础方案：**
    

a .用户输入+虚拟人上一句回复  组成输入文本

1.  将输入文本切词（）
    
2.  将切词通过联想词表，通过查表生成 1:100的 扩充词表
    
3.  根据词频重复加权（既任意单词在扩充此表中重复出现的次数）对扩充此表重排
    
4.  取权重排序后的扩充词表前N位进行记忆召回
    

1.  **远景方案：**
    

1.  用户输入+虚拟人上一句回复  组成输入文本
    
2.  将文本输入扩词神经网络模型得到带权重的扩充词表
    
3.  扩充词表前N位进行记忆召回
    

1.  **扩词神经网络模型如何训练**
    

1.  从互联网上获取足够多的文本资料（小说，对话）作为训练资料
    
2.  切句后，将句子采用基础方案获得重排序后的扩充词表前100位。
    
3.  使用LLM对扩充词打分评价（从切句到扩充词表的合理性）,**评分不及格的句子跳过**。
    
4.  将评分超过阈值的句子和对应的扩充词表作为数据训练模型。
    

## 十一、联想词库的执行策略

1.  输入参数：待联想文本、最大联想词数、联想策略(数值)，过滤等级(比如\[1\])
    
2.  输入处理：将待联想文本切词后（切位目标词），从数据库中获得相应的词条。
    
3.  按如下联想策略进行处理：
    

     策略0（默认）：依次将每个目标词的联想词中联想概率最大的词塞入队列，直至达到最大联想词数。

     策略1（混合）：将目标词的联想词/概率等级全部塞入一个队列，统计每个词的复现频率，复现1次的，概率等级上升**2级（暂定）**。对所有词语按调整后的概率等级重新排序。按概率等级高低输出联想词，直至达到最大联想词数。\[效果优于策略0\]

### 11.1 联想词调用接口：

输入：chinese\_rd\_count为数量； logic\_type=‘first’/‘second’  ;  filter\_values过滤等级，如果为\[0\]表示不过滤

```powershell
curl --location 'http://192.168.52.114:8088/expand_words' \
--header 'Content-Type: application/json' \
--data '{ \
  "sentence": "前缀可能是人为加上的标识", \
  "chinese_rd_count": 100, \
  "logic_type": "second", \
  "filter_values": [1] \
}'
```

响应, 解析‘expanded\_words’ 里面是对应联想词和概率登记：

```powershell
{
    "原始关键词列表": original_keywords,
    "输入的单词列表": input_words,
    "扩展的联想词列表": expanded_words
}
```

**优化点**：

1、这里单词是独立的，没有完整语义联想，而且排序依赖了分词的先后顺序不够合理（要么NER时有权重分词排序）

2、需要对句子分词后，什么词来输入联想要有策略的，不能什么都放入

3、jieba分词第一次加载会慢，后面在内存后速度才快

```json
"检索耗时": {
            "向量+embedding检索": "8.95 毫秒",
            "mysql检索": "364.83 毫秒",
            "扩词算法": "4.21毫秒",
            "重排算法": "599.85毫秒"
        },
```

 **实装使用的system prompt：**

[请至钉钉文档查看附件《记忆提炼大师lisp2.0.txt》](https://alidocs.dingtalk.com/i/nodes/NkDwLng8ZQQ1rQYdT0oXyXbEJKMEvZBY?doc_type=wiki_doc&iframeQuery=anchorId%3DX02m53fgm9jy1owsosxpkd)

## 十二、查询调用接口定义

### 1、第一版、记忆查询v18.0

**调用接口为：**  **http://192.168.52.114:8012/query** 

还有一版简化接口（只查看记忆内容）：http://192.168.52.114:8012/query\_simple 

输入案例【curl调用，自行转成python或C++请求】：

```mysql
curl --location 'http://192.168.52.114:8012/query' \
--header 'Content-Type: application/json' \
--data '{
  "query": "你觉得你擅长啥",
  "limit": 5
}'

------补充------
还有个可选参数'score_threshold'为0-1，越大过滤越严格，默认0.56
```

**query** 输出返回3个kV：

1、memory\_events表示记忆事件；

2、memory\_entities表示记忆实体属性关系；

*   \- memory\_entities中的kind分类可以有\[user属性\]、\[user关系\]、\[其他属性\]、\[其他关系\]
    

3、additional\_info包括耗时，分词，扩词可视化

```mysql
class QueryResponse(BaseModel):
    memory_events: List[Dict]
    memory_entities: List[Dict]
    additional_info: Dict
```

返回的记忆召回已按照重要性排序，越前面越重要。数据包括了【score， 原文index索引，内容， 思考， 关键词，时间】信息，也可以直接看log。**对limit代码内部已经做了得分过滤机制，防止过多不相关记忆召回【可开放让它多召回】**。

```mysql
{
    "memory_events": [
        {
            "id": 0,
            "score": 0.5833,
            "index": "399",
            "description": "祁煜提议在画廊的圣诞装饰中加入红色元素，认为像木木脸颊泛起的颜色一样温暖。木木认为红色真的很适合圣诞节，像壁炉里的火焰一样温暖。",
            "deepinsight": "木木对色彩有敏锐的感知，能够将色彩与情感联系起来，创造出有温度的装饰。",
            "updatetime": "2020-12-15 18:32:12",
            "keyword": [
                "红色元素",
                "温暖",
                "壁炉",
                "圣诞节",
                "装饰"
            ],
            "log": "[记忆事件]--score=0.5833,index=399.在2020-12-15 18:32:12左右, 地点：木木的家中。详细记忆事件为祁煜提议在画廊的圣诞装饰中加入红色元素，认为像木木脸颊泛起的颜色一样温暖。木木认为红色真的很适合圣诞节，像壁炉里的火焰一样温暖。这表明了木木对色彩有敏锐的感知，能够将色彩与情感联系起来，创造出有温度的装饰。"
        },
        {
            "id": 1,
            "score": 0.5747,
            "index": "402",
            "description": "木木考虑找红衣模特增加画面张力，祁煜提议自己当主角，并提到自己的蓝紫色瞳孔与红色的绝配。",
            "deepinsight": "木木在寻找摄影灵感，祁煜的提议激发了她的创作灵感。",
            "updatetime": "2021-01-05 18:45:33",
            "keyword": [
                "红衣模特",
                "蓝紫色瞳孔",
                "色彩灵感",
                "摄影",
                "创作"
            ],
            "log": "[记忆事件]--score=0.5747,index=402.在2021-01-05 18:45:33左右, 地点：咖啡馆。详细记忆事件为木木考虑找红衣模特增加画面张力，祁煜提议自己当主角，并提到自己的蓝紫色瞳孔与红色的绝配。这表明了木木在寻找摄影灵感，祁煜的提议激发了她的创作灵感。"
        }
    ],
    "memory_entities": [
        {
            "id": 0,
            "kind": "用户属性",
            "score": 0.0,
            "index": {
                "index": 2947
            },
            "description": "木木对星座和蓝玫瑰感兴趣",
            "updatetime": "2024-09-24T13:00:00",
            "matched_keywords": [
                "玫瑰"
            ],
            "keyword": "兴趣",
            "log": "用户属性--score=0.0000,index={'index': 2947}, 木木对星座和蓝玫瑰感兴趣---命中['玫瑰']，数据库关键词: 兴趣"
        },
        {
            "id": 1,
            "kind": "用户属性",
            "score": 0.0,
            "index": {
                "index": 2944
            },
            "description": "木木喜欢温柔的颜色和莫兰迪色系",
            "updatetime": "2024-09-24T09:05:12",
            "matched_keywords": [
                "颜色"
            ],
            "keyword": "审美",
            "log": "用户属性--score=0.0000,index={'index': 2944}, 木木喜欢温柔的颜色和莫兰迪色系---命中['颜色']，数据库关键词: 审美"
        },
        {
            "id": 2,
            "kind": "用户属性",
            "score": 0.0,
            "index": {
                "index": 2942
            },
            "description": "木木对艺术和色彩有研究",
            "updatetime": "2024-09-23T23:05:12",
            "matched_keywords": [
                "色彩"
            ],
            "keyword": "兴趣",
            "log": "用户属性--score=0.0000,index={'index': 2942}, 木木对艺术和色彩有研究---命中['色彩']，数据库关键词: 兴趣"
        }
    ],
    "additional_info": {
        "检索耗时": {
            "向量+embedding检索": "11.20 毫秒",
            "mysql检索": "191.33 毫秒",
            "扩词算法": "6.24毫秒",
            "重排算法": "169.68毫秒"
        },
        "query": "红色",
        "分词": [
            "红色"
        ],
        "给联想的基词": [
            "红色"
        ],
        "扩展后联想词": [
            {
                "革命": 7
            },
            {
                "红旗": 7
            },
            {
                "喜庆": 7
            },
            {
                "灯笼": 6
            },
            {
                "玫瑰": 6
            },
            {
                "火焰": 6
            },
            {
                "警示": 6
            },
            {
                "鲜血": 5
            },
            {
                "交通灯": 5
            },
            {
                "太阳": 5
            },
            {
                "颜色": 5
            },
            {
                "色彩": 5
            }
        ]
    }
}
```

**实体属性搜索策略：**

1、优先搜索用户'木木’的信息，搜索条件遍历扩词列表 判断是否在 (keyword 字段 or description 字段)，按照时间倒序排

2、进一步搜索一般性实体（非用户客体）中召回相关信息，搜索条件 遍历扩词列表 判断是否在 （keyword字段 或 entity\_name实体字段）

#### 查询效果优化点

1、分词需要针对优化，比如对不合理的分词进行词表扩展

2、联想词后期要自己构建映射表更换\[很长期的迭代需要\]

3、如果向量召回不好需要对比不同的embedding看效果，或者调整混合检索的系数和策略。这里有很大的调整空间

4、各种算法推理，数据库查询的响应优化

### 2、第二版、记忆查询v22.0

**调用接口为：**  **http://192.168.52.114:8013/query** 

还有一版简化接口（只查看记忆内容）：http://192.168.52.114:8013/query\_simple 

输入案例【curl调用，自行转成python或C++请求】：

```mysql
curl --location 'http://192.168.52.114:8012/query' \
--header 'Content-Type: application/json' \
--data '{
  "query": "你觉得你擅长啥",
  "limit": 5
}'
```

**实体属性搜索策略：**

1、优先搜索用户'木木’的属性（kind='用户属性'），搜索条件遍历扩词列表 判断是否在 (keyword 字段 or description 字段)，这里要增加停用词（用户名和agent要过滤）按照时间倒序排

2、进一步搜索kind='与主体和客体的关系'过滤，搜索条件 遍历扩词列表 判断是否在 （keyword字段）

3、关于一些补充信息： 过滤kind=‘属性’ and entity\_type='特殊实体'，搜索条件 搜索条件 遍历扩词列表 判断是否在 （entity\_name字段）【属性的entity\_name要和description拼接才是完整的】

4、记忆画面：过滤kind='记忆画面', 搜索条件 搜索条件 遍历扩词列表 判断是否在 （keyword字段）

**查询效果优化点**

1、用户属性需要去重整合

2、泛化实体对‘与其他实体的关系’的description信息简单没啥用

3、句子完整性有点差，对精排不友好

4、要去掉分词用户和AI的名字【已解决】

### 3、第三版、记忆查询v23.0

**调用接口为：**  **http://192.168.52.114:8014/query** 

还有一版简化接口（只查看记忆内容）：http://192.168.52.114:8014/query\_simple 

输入案例【curl调用，自行转成python或C++请求】：

```mysql
curl --location 'http://192.168.52.114:8014/query' \
--header 'Content-Type: application/json' \
--data '{
  "query": "你觉得你擅长啥",
  "limit": 5
}'
```

选用deepseek

*   qwen-plus倾向输出`"特殊实体属性"`，需要结合"实体名"拼接为完整语义。---感觉比较平常优先级最低（但我又想和关系一起召回为一条，感觉会很完善记忆描述）
    
*   deepseek-plus大部分都只输出`"与主体和客体的关系"`。
    

**实体属性搜索策略：**

1、搜索（kind='与主体和客体的关系'）过滤，搜索条件 遍历扩词列表 判断是否在 （keyword字段）

2、搜索用户'木木’的属性（kind='用户属性'），搜索条件遍历扩词列表 判断是否在 (keyword 字段 or description 字段--排除名字)

3、针对(kind='特殊实体属性' or  '与其它实体的关系'), 搜索条件 遍历扩词列表 判断是否在 （keyword字段）

**查询效果优化点**

1、对长度=1的keyword不参与在description中的搜索

2、采用TF-IDF进行关键词提取，规定top10以内的分词结果

3、比如用户问‘生日’相关的，但是keyword其实没用生日总结，都在关系描述中导致搜索不到:

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/mxPOGyJ29LoJnKa9/img/52a7d1e3-4149-4a68-9848-57d95957cb4f.png)

### 4、第四版、记忆查询v23.0\_es

 **调用接口为：**  **http://192.168.52.114:8015/query** 

还有一版简化接口（只查看记忆内容）：http://192.168.52.114:8015/query\_simple 

```c++
curl --location 'http://192.168.52.114:8015/query' \
--header 'Content-Type: application/json' \
--data '{
  "query": "室友失恋了，我们陪她吃了一晚上火锅",
  "limit": 5,
  "score_threshold": 0.5
}'
```

**优化点**：

1、改用elaticsearch数据库，支持快速全文检索。

2、强化了召回策略： 关键词匹配（带有权重区分）+ 时间戳间隔加权的 融合排序

3、在内部实现排序，去掉后处理精排这个耗时的算法

4、（待实现）对语义排序进行多路召回融合（a、并行加权  b、在关键词和时间戳后进行语义干涉）